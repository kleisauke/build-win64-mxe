This file is part of MXE. See LICENSE.md for licensing information.

Contains ad hoc patches for cross building.

From 0000000000000000000000000000000000000000 Mon Sep 17 00:00:00 2001
From: Kleis Auke Wolthuizen <github@kleisauke.nl>
Date: Thu, 28 Nov 2019 12:00:00 +0100
Subject: [PATCH 1/4] Use H5make_libsettings.c from native build


diff --git a/src/CMakeLists.txt b/src/CMakeLists.txt
index 1111111..2222222 100644
--- a/src/CMakeLists.txt
+++ b/src/CMakeLists.txt
@@ -1087,38 +1087,61 @@ else ()
   endif ()
 endif ()
 
-add_executable (H5make_libsettings ${HDF5_SRC_DIR}/H5make_libsettings.c)
-target_include_directories (H5make_libsettings PRIVATE "${HDF5_SRC_DIR};${HDF5_BINARY_DIR};$<$<BOOL:${HDF5_ENABLE_PARALLEL}>:${MPI_C_INCLUDE_DIRS}>")
-target_compile_definitions(H5make_libsettings PUBLIC ${HDF_EXTRA_C_FLAGS} ${HDF_EXTRA_FLAGS})
-TARGET_C_PROPERTIES (H5make_libsettings STATIC)
-target_link_libraries (H5make_libsettings
-    PRIVATE "$<$<BOOL:${HDF5_ENABLE_PARALLEL}>:${MPI_C_LIBRARIES}>" $<$<OR:$<PLATFORM_ID:Windows>,$<PLATFORM_ID:MinGW>>:ws2_32.lib>
-    PRIVATE $<$<PLATFORM_ID:Emscripten>:"-O0">
-)
-
-add_custom_command (
-    OUTPUT ${HDF5_BINARY_DIR}/H5lib_settings.c
-           ${HDF5_BINARY_DIR}/gen_SRCS.stamp2
-    COMMAND ${CMAKE_CROSSCOMPILING_EMULATOR} $<TARGET_FILE:H5make_libsettings>
-    ARGS ${HDF5_BINARY_DIR}/H5lib_settings.c
-    COMMAND    ${CMAKE_COMMAND}
-    ARGS       -E touch ${HDF5_GENERATED_SOURCE_DIR}/gen_SRCS.stamp2
-    DEPENDS H5make_libsettings
-    WORKING_DIRECTORY ${HDF5_BINARY_DIR}
-)
-set_source_files_properties (${HDF5_BINARY_DIR}/H5lib_settings.c PROPERTIES GENERATED TRUE)
-if (BUILD_SHARED_LIBS)
+if (NOT EXISTS "${HDF5_BINARY_DIR}/H5lib_settings.c")
+  add_executable (H5make_libsettings ${HDF5_SRC_DIR}/H5make_libsettings.c)
+  target_include_directories (H5make_libsettings PRIVATE "${HDF5_SRC_DIR};${HDF5_BINARY_DIR};$<$<BOOL:${HDF5_ENABLE_PARALLEL}>:${MPI_C_INCLUDE_DIRS}>")
+  target_compile_definitions(H5make_libsettings PUBLIC ${HDF_EXTRA_C_FLAGS} ${HDF_EXTRA_FLAGS})
+  TARGET_C_PROPERTIES (H5make_libsettings STATIC)
+  target_link_libraries (H5make_libsettings
+      PRIVATE "$<$<BOOL:${HDF5_ENABLE_PARALLEL}>:${MPI_C_LIBRARIES}>" $<$<OR:$<PLATFORM_ID:Windows>,$<PLATFORM_ID:MinGW>>:ws2_32.lib>
+      PRIVATE $<$<PLATFORM_ID:Emscripten>:"-O0">
+  )
+  
   add_custom_command (
-      OUTPUT ${HDF5_BINARY_DIR}/shared/H5lib_settings.c
-             ${HDF5_BINARY_DIR}/shared/shared_gen_SRCS.stamp2
-      COMMAND    ${CMAKE_COMMAND}
-      ARGS       -E copy_if_different "${HDF5_BINARY_DIR}/H5lib_settings.c" "${HDF5_BINARY_DIR}/shared/H5lib_settings.c"
+      OUTPUT ${HDF5_BINARY_DIR}/H5lib_settings.c
+             ${HDF5_BINARY_DIR}/gen_SRCS.stamp2
+      COMMAND ${CMAKE_CROSSCOMPILING_EMULATOR} $<TARGET_FILE:H5make_libsettings>
+      ARGS ${HDF5_BINARY_DIR}/H5lib_settings.c
       COMMAND    ${CMAKE_COMMAND}
-      ARGS       -E touch ${HDF5_GENERATED_SOURCE_DIR}/shared/shared_gen_SRCS.stamp2
-      DEPENDS    ${HDF5_BINARY_DIR}/H5lib_settings.c
+      ARGS       -E touch ${HDF5_BINARY_DIR}/gen_SRCS.stamp2
+      DEPENDS H5make_libsettings
       WORKING_DIRECTORY ${HDF5_BINARY_DIR}
   )
-  set_source_files_properties (${HDF5_BINARY_DIR}/shared/H5lib_settings.c PROPERTIES GENERATED TRUE)
+  set_source_files_properties (${HDF5_BINARY_DIR}/H5lib_settings.c PROPERTIES GENERATED TRUE)
+  if (BUILD_SHARED_LIBS)
+    add_custom_command (
+        OUTPUT ${HDF5_BINARY_DIR}/shared/H5lib_settings.c
+               ${HDF5_BINARY_DIR}/shared/shared_gen_SRCS.stamp2
+        COMMAND    ${CMAKE_COMMAND}
+        ARGS       -E copy_if_different "${HDF5_BINARY_DIR}/H5lib_settings.c" "${HDF5_BINARY_DIR}/shared/H5lib_settings.c"
+        COMMAND    ${CMAKE_COMMAND}
+        ARGS       -E touch ${HDF5_BINARY_DIR}/shared/shared_gen_SRCS.stamp2
+        DEPENDS    ${HDF5_BINARY_DIR}/H5lib_settings.c
+        WORKING_DIRECTORY ${HDF5_BINARY_DIR}
+    )
+    set_source_files_properties (${HDF5_BINARY_DIR}/shared/H5lib_settings.c PROPERTIES GENERATED TRUE)
+  endif ()
+else ()
+  add_custom_command (
+      OUTPUT ${HDF5_BINARY_DIR}/gen_SRCS.stamp2
+      COMMAND    ${CMAKE_COMMAND}
+      ARGS       -E touch ${HDF5_BINARY_DIR}/gen_SRCS.stamp2
+      DEPENDS    ${HDF5_BINARY_DIR}/H5lib_settings.c
+      WORKING_DIRECTORY ${HDF5_BINARY_DIR}
+   )
+  if (BUILD_SHARED_LIBS)
+    add_custom_command (
+        OUTPUT ${HDF5_BINARY_DIR}/shared/H5lib_settings.c
+               ${HDF5_BINARY_DIR}/shared/shared_gen_SRCS.stamp2
+        COMMAND    ${CMAKE_COMMAND}
+        ARGS       -E copy_if_different "${HDF5_BINARY_DIR}/H5lib_settings.c" "${HDF5_BINARY_DIR}/shared/H5lib_settings.c"
+        COMMAND    ${CMAKE_COMMAND}
+        ARGS       -E touch ${HDF5_BINARY_DIR}/shared/shared_gen_SRCS.stamp2
+        DEPENDS    ${HDF5_BINARY_DIR}/H5lib_settings.c
+        WORKING_DIRECTORY ${HDF5_BINARY_DIR}
+    )
+    set_source_files_properties (${HDF5_BINARY_DIR}/shared/H5lib_settings.c PROPERTIES GENERATED TRUE)
+  endif ()
 endif ()
 
 ## all_packages="AC,B,B2,D,F,FA,FL,FS,HL,I,O,S,ST,T,Z"

From 0000000000000000000000000000000000000000 Mon Sep 17 00:00:00 2001
From: Tom Schoonjans <Tom.Schoonjans@diamond.ac.uk>
Date: Tue, 27 Feb 2018 15:49:30 +0000
Subject: [PATCH 2/4] Restore MSYS/MINGW support


diff --git a/config/cmake_ext_mod/HDFMacros.cmake b/config/cmake_ext_mod/HDFMacros.cmake
index 1111111..2222222 100644
--- a/config/cmake_ext_mod/HDFMacros.cmake
+++ b/config/cmake_ext_mod/HDFMacros.cmake
@@ -142,15 +142,6 @@ macro (HDF_SET_LIB_OPTIONS libtarget libname libtype)
       )
     endif ()
   endif ()
-
-  #----- Use MSVC Naming conventions for Shared Libraries
-  if (MINGW AND ${libtype} MATCHES "SHARED")
-    set_target_properties (${libtarget} PROPERTIES
-        IMPORT_SUFFIX ".lib"
-        IMPORT_PREFIX ""
-        PREFIX ""
-    )
-  endif ()
 endmacro ()
 
 #-------------------------------------------------------------------------------
@@ -170,7 +161,7 @@ macro (HDF_IMPORT_SET_LIB_OPTIONS libtarget libname libtype libversion)
     if (WIN32)
       if (MINGW)
         set_target_properties (${libtarget} PROPERTIES
-            IMPORTED_IMPLIB "${CMAKE_LIBRARY_OUTPUT_DIRECTORY}/${IMPORT_LIB_NAME}.lib"
+            IMPORTED_IMPLIB "${CMAKE_LIBRARY_OUTPUT_DIRECTORY}/${IMPORT_LIB_NAME}${CMAKE_IMPORT_LIBRARY_SUFFIX}"
             IMPORTED_LOCATION "${CMAKE_LIBRARY_OUTPUT_DIRECTORY}/${IMPORT_LIB_NAME}${CMAKE_SHARED_LIBRARY_SUFFIX}"
         )
       else ()
diff --git a/src/H5system.c b/src/H5system.c
index 1111111..2222222 100644
--- a/src/H5system.c
+++ b/src/H5system.c
@@ -838,6 +838,10 @@ Wgettimeofday(struct timeval *tv, struct timezone *tz)
  *
  *-------------------------------------------------------------------------
  */
+#ifdef H5_HAVE_MINGW
+// definition of getenv_s is currently missing in MinGW, appears to be a bug
+_CRTIMP errno_t __cdecl getenv_s(size_t *pReturnValue, char *buffer, size_t numberOfElements, const char *varname);
+#endif
 int
 Wsetenv(const char *name, const char *value, int overwrite)
 {

From 0000000000000000000000000000000000000000 Mon Sep 17 00:00:00 2001
From: Kleis Auke Wolthuizen <github@kleisauke.nl>
Date: Thu, 26 Dec 2019 09:45:00 +0100
Subject: [PATCH 3/4] Remove -static-[libgcc,libstdc++] linker flags

It won't work with llvm-mingw.

diff --git a/c++/examples/CMakeLists.txt b/c++/examples/CMakeLists.txt
index 1111111..2222222 100644
--- a/c++/examples/CMakeLists.txt
+++ b/c++/examples/CMakeLists.txt
@@ -41,11 +41,6 @@ foreach (example ${examples})
   else ()
     TARGET_C_PROPERTIES (cpp_ex_${example} SHARED)
     target_link_libraries (cpp_ex_${example} PRIVATE ${HDF5_CPP_LIBSH_TARGET} ${HDF5_LIBSH_TARGET})
-    if (MINGW)
-      target_link_options (${HDF5_CPP_LIBSH_TARGET}
-          PRIVATE -static-libgcc -static-libstdc++
-      )
-    endif ()
   endif ()
   set_target_properties (cpp_ex_${example} PROPERTIES FOLDER examples/cpp)
 endforeach ()
@@ -59,11 +54,6 @@ foreach (example ${tutr_examples})
   else ()
     TARGET_C_PROPERTIES (cpp_ex_${example} SHARED)
     target_link_libraries (cpp_ex_${example} PRIVATE ${HDF5_CPP_LIBSH_TARGET} ${HDF5_LIBSH_TARGET})
-    if (MINGW)
-      target_link_options (${HDF5_CPP_LIBSH_TARGET}
-          PRIVATE -static-libgcc -static-libstdc++
-      )
-    endif ()
   endif ()
   set_target_properties (cpp_ex_${example} PROPERTIES FOLDER examples/cpp)
 endforeach ()
diff --git a/c++/src/CMakeLists.txt b/c++/src/CMakeLists.txt
index 1111111..2222222 100644
--- a/c++/src/CMakeLists.txt
+++ b/c++/src/CMakeLists.txt
@@ -115,11 +115,6 @@ if (BUILD_SHARED_LIBS)
   target_link_libraries (${HDF5_CPP_LIBSH_TARGET}
       PUBLIC ${HDF5_LIBSH_TARGET}
   )
-  if (MINGW)
-    target_link_options (${HDF5_CPP_LIBSH_TARGET}
-        PRIVATE -static-libgcc -static-libstdc++
-    )
-  endif ()
   set_global_variable (HDF5_LIBRARIES_TO_EXPORT "${HDF5_LIBRARIES_TO_EXPORT};${HDF5_CPP_LIBSH_TARGET}")
   H5_SET_LIB_OPTIONS (${HDF5_CPP_LIBSH_TARGET} ${HDF5_CPP_LIB_NAME} SHARED "CXX")
   set_target_properties (${HDF5_CPP_LIBSH_TARGET} PROPERTIES FOLDER libraries/cpp)
diff --git a/c++/test/CMakeLists.txt b/c++/test/CMakeLists.txt
index 1111111..2222222 100644
--- a/c++/test/CMakeLists.txt
+++ b/c++/test/CMakeLists.txt
@@ -48,10 +48,6 @@ if (NOT BUILD_SHARED_LIBS)
 else ()
   TARGET_C_PROPERTIES (cpp_testhdf5 SHARED)
   target_link_libraries (cpp_testhdf5 PRIVATE ${HDF5_CPP_LIBSH_TARGET} ${HDF5_LIBSH_TARGET} ${HDF5_TEST_LIBSH_TARGET})
-  if (MINGW)
-    target_link_options (${HDF5_CPP_LIBSH_TARGET}
-        PRIVATE -static-libgcc -static-libstdc++
-    )
   endif ()
 endif ()
 set_target_properties (cpp_testhdf5 PROPERTIES FOLDER test/cpp)

From 0000000000000000000000000000000000000000 Mon Sep 17 00:00:00 2001
From: Kleis Auke Wolthuizen <github@kleisauke.nl>
Date: Sun, 7 Mar 2021 00:00:00 +0100
Subject: [PATCH 1/1] Use dllexport/dllimport also for MinGW targets


diff --git a/src/H5api_adpt.h b/src/H5api_adpt.h
index 1111111..2222222 100644
--- a/src/H5api_adpt.h
+++ b/src/H5api_adpt.h
@@ -24,7 +24,7 @@
 #ifdef H5_BUILT_AS_DYNAMIC_LIB
 
 #if defined(hdf5_shared_EXPORTS)
-  #if defined (_MSC_VER)  /* MSVC Compiler Case */
+  #if defined (_MSC_VER) || defined(__MINGW32__)  /* MSVC/MinGW Compiler Case */
     #define H5_DLL __declspec(dllexport)
     #define H5_DLLVAR extern __declspec(dllexport)
   #elif (__GNUC__ >= 4)  /* GCC 4.x has support for visibility options */
@@ -32,7 +32,7 @@
     #define H5_DLLVAR extern __attribute__ ((visibility("default")))
   #endif
 #else
-  #if defined (_MSC_VER)  /* MSVC Compiler Case */
+  #if defined (_MSC_VER) || defined(__MINGW32__)  /* MSVC/MinGW Compiler Case */
     #define H5_DLL __declspec(dllimport)
     #define H5_DLLVAR __declspec(dllimport)
   #elif (__GNUC__ >= 4)  /* GCC 4.x has support for visibility options */
@@ -47,7 +47,7 @@
 #endif /* _HDF5DLL_ */
 
 #if defined(hdf5_test_shared_EXPORTS)
-  #if defined (_MSC_VER)  /* MSVC Compiler Case */
+  #if defined (_MSC_VER) || defined(__MINGW32__)  /* MSVC/MinGW Compiler Case */
     #define H5TEST_DLL __declspec(dllexport)
     #define H5TEST_DLLVAR extern __declspec(dllexport)
   #elif (__GNUC__ >= 4)  /* GCC 4.x has support for visibility options */
@@ -55,7 +55,7 @@
     #define H5TEST_DLLVAR extern __attribute__ ((visibility("default")))
   #endif
 #else
-  #if defined (_MSC_VER)  /* MSVC Compiler Case */
+  #if defined (_MSC_VER) || defined(__MINGW32__)  /* MSVC/MinGW Compiler Case */
     #define H5TEST_DLL __declspec(dllimport)
     #define H5TEST_DLLVAR __declspec(dllimport)
   #elif (__GNUC__ >= 4)  /* GCC 4.x has support for visibility options */
@@ -70,7 +70,7 @@
 #endif /* H5TEST_DLL */
 
 #if defined(hdf5_tools_shared_EXPORTS)
-  #if defined (_MSC_VER)  /* MSVC Compiler Case */
+  #if defined (_MSC_VER) || defined(__MINGW32__)  /* MSVC/MinGW Compiler Case */
     #define H5TOOLS_DLL __declspec(dllexport)
     #define H5TOOLS_DLLVAR extern __declspec(dllexport)
   #elif (__GNUC__ >= 4)  /* GCC 4.x has support for visibility options */
@@ -78,7 +78,7 @@
     #define H5TOOLS_DLLVAR extern __attribute__ ((visibility("default")))
   #endif
 #else
-  #if defined (_MSC_VER)  /* MSVC Compiler Case */
+  #if defined (_MSC_VER) || defined(__MINGW32__)  /* MSVC/MinGW Compiler Case */
     #define H5TOOLS_DLL __declspec(dllimport)
     #define H5TOOLS_DLLVAR __declspec(dllimport)
   #elif (__GNUC__ >= 4)  /* GCC 4.x has support for visibility options */
@@ -93,7 +93,7 @@
 #endif /* H5TOOLS_DLL */
 
 #if defined(hdf5_cpp_shared_EXPORTS)
-  #if defined (_MSC_VER)  /* MSVC Compiler Case */
+  #if defined (_MSC_VER) || defined(__MINGW32__)  /* MSVC/MinGW Compiler Case */
     #define H5_DLLCPP __declspec(dllexport)
     #define H5_DLLCPPVAR extern __declspec(dllexport)
   #elif (__GNUC__ >= 4)  /* GCC 4.x has support for visibility options */
@@ -101,7 +101,7 @@
     #define H5_DLLCPPVAR extern __attribute__ ((visibility("default")))
   #endif
 #else
-  #if defined (_MSC_VER)  /* MSVC Compiler Case */
+  #if defined (_MSC_VER) || defined(__MINGW32__)  /* MSVC/MinGW Compiler Case */
     #define H5_DLLCPP __declspec(dllimport)
     #define H5_DLLCPPVAR __declspec(dllimport)
   #elif (__GNUC__ >= 4)  /* GCC 4.x has support for visibility options */
@@ -116,7 +116,7 @@
 #endif /* H5_DLLCPP */
 
 #if defined(hdf5_hl_shared_EXPORTS)
-  #if defined (_MSC_VER)  /* MSVC Compiler Case */
+  #if defined (_MSC_VER) || defined(__MINGW32__)  /* MSVC/MinGW Compiler Case */
     #define H5_HLDLL __declspec(dllexport)
     #define H5_HLDLLVAR extern __declspec(dllexport)
   #elif (__GNUC__ >= 4)  /* GCC 4.x has support for visibility options */
@@ -124,7 +124,7 @@
     #define H5_HLDLLVAR extern __attribute__ ((visibility("default")))
   #endif
 #else
-  #if defined (_MSC_VER)  /* MSVC Compiler Case */
+  #if defined (_MSC_VER) || defined(__MINGW32__)  /* MSVC/MinGW Compiler Case */
     #define H5_HLDLL __declspec(dllimport)
     #define H5_HLDLLVAR __declspec(dllimport)
   #elif (__GNUC__ >= 4)  /* GCC 4.x has support for visibility options */
@@ -139,7 +139,7 @@
 #endif /* H5_HLDLL */
 
 #if defined(hdf5_hl_cpp_shared_EXPORTS)
-  #if defined (_MSC_VER)  /* MSVC Compiler Case */
+  #if defined (_MSC_VER) || defined(__MINGW32__)  /* MSVC/MinGW Compiler Case */
     #define H5_HLCPPDLL __declspec(dllexport)
     #define H5_HLCPPDLLVAR extern __declspec(dllexport)
   #elif (__GNUC__ >= 4)  /* GCC 4.x has support for visibility options */
@@ -147,7 +147,7 @@
     #define H5_HLCPPDLLVAR extern __attribute__ ((visibility("default")))
   #endif
 #else
-  #if defined (_MSC_VER)  /* MSVC Compiler Case */
+  #if defined (_MSC_VER) || defined(__MINGW32__)  /* MSVC/MinGW Compiler Case */
     #define H5_HLCPPDLL __declspec(dllimport)
     #define H5_HLCPPDLLVAR __declspec(dllimport)
   #elif (__GNUC__ >= 4)  /* GCC 4.x has support for visibility options */
@@ -162,7 +162,7 @@
 #endif /* H5_HLCPPDLL */
 
 #if defined(hdf5_f90cstub_shared_EXPORTS)
-  #if defined (_MSC_VER)  /* MSVC Compiler Case */
+  #if defined (_MSC_VER) || defined(__MINGW32__)  /* MSVC/MinGW Compiler Case */
     #define H5_FCDLL __declspec(dllexport)
     #define H5_FCDLLVAR extern __declspec(dllexport)
   #elif (__GNUC__ >= 4)  /* GCC 4.x has support for visibility options */
@@ -170,7 +170,7 @@
     #define H5_FCDLLVAR extern __attribute__ ((visibility("default")))
   #endif
 #else
-  #if defined (_MSC_VER)  /* MSVC Compiler Case */
+  #if defined (_MSC_VER) || defined(__MINGW32__)  /* MSVC/MinGW Compiler Case */
     #define H5_FCDLL __declspec(dllimport)
     #define H5_FCDLLVAR __declspec(dllimport)
   #elif (__GNUC__ >= 4)  /* GCC 4.x has support for visibility options */
@@ -185,7 +185,7 @@
 #endif /* H5_FCDLL */
 
 #if defined(hdf5_test_f90cstub_shared_EXPORTS)
-  #if defined (_MSC_VER)  /* MSVC Compiler Case */
+  #if defined (_MSC_VER) || defined(__MINGW32__)  /* MSVC/MinGW Compiler Case */
     #define H5_FCTESTDLL __declspec(dllexport)
     #define H5_FCTESTDLLVAR extern __declspec(dllexport)
   #elif (__GNUC__ >= 4)  /* GCC 4.x has support for visibility options */
@@ -193,7 +193,7 @@
     #define H5_FCTESTDLLVAR extern __attribute__ ((visibility("default")))
   #endif
 #else
-  #if defined (_MSC_VER)  /* MSVC Compiler Case */
+  #if defined (_MSC_VER) || defined(__MINGW32__)  /* MSVC/MinGW Compiler Case */
     #define H5_FCTESTDLL __declspec(dllimport)
     #define H5_FCTESTDLLVAR __declspec(dllimport)
   #elif (__GNUC__ >= 4)  /* GCC 4.x has support for visibility options */
@@ -208,7 +208,7 @@
 #endif /* H5_FCTESTDLL */
 
 #if defined(hdf5_hl_f90cstub_shared_EXPORTS)
-  #if defined (_MSC_VER)  /* MSVC Compiler Case */
+  #if defined (_MSC_VER) || defined(__MINGW32__)  /* MSVC/MinGW Compiler Case */
     #define HDF5_HL_F90CSTUBDLL __declspec(dllexport)
     #define HDF5_HL_F90CSTUBDLLVAR extern __declspec(dllexport)
   #elif (__GNUC__ >= 4)  /* GCC 4.x has support for visibility options */
@@ -216,7 +216,7 @@
     #define HDF5_HL_F90CSTUBDLLVAR extern __attribute__ ((visibility("default")))
   #endif
 #else
-  #if defined (_MSC_VER)  /* MSVC Compiler Case */
+  #if defined (_MSC_VER) || defined(__MINGW32__)  /* MSVC/MinGW Compiler Case */
     #define HDF5_HL_F90CSTUBDLL __declspec(dllimport)
     #define HDF5_HL_F90CSTUBDLLVAR __declspec(dllimport)
   #elif (__GNUC__ >= 4)  /* GCC 4.x has support for visibility options */
