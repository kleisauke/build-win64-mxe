# Rust toolchain is needed for librsvg
# TODO: 1.34.0 fails due to https://github.com/rust-lang/rust/issues/58277
FROM rust:1.33.0-stretch

ARG ARCH=x86_64
ARG MESON_PATCH=https://raw.githubusercontent.com/libvips/build-win64-mxe/master/8.7/meson-3939.patch

RUN \
    apt-get update \
    && apt-get install -y \
        # http://mxe.cc/#requirements-debian
        autopoint bison flex gettext gperf intltool \ 
        libtool-bin libxml-parser-perl lzip p7zip-full \
        ruby g++-multilib libc6-dev-i386 \
        # needed when building libvips from git
        gobject-introspection swig gtk-doc-tools \
        # needed for Ninja and Meson
        python3-pip

# Add Windows target for cross-compilation
RUN \
    rustup target add ${ARCH}-pc-windows-gnu

# Install Ninja and Meson
RUN \
    pip3 install ninja meson

# TODO: Remove if https://github.com/mesonbuild/meson/pull/3939 is merged
RUN \
	cd `python3 -c "import site; print(site.getsitepackages()[0])"` \
	&& curl $MESON_PATCH | git apply -v

# the versioned build dir is mounted at /data, so this runs the build script
# in that
ENTRYPOINT ["/bin/bash", "/data/build.sh"]

# The versioned subdirectory is mounted here
WORKDIR /data
